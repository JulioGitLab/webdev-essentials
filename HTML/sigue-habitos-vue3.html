<!doctype html>
<!-- ES: Este proyecto muestra un rastreador de hábitos sencillo construido con Vue.js, usando la Options API y la sintaxis HTML.

   Por simplicidad, Vue se carga desde un CDN mediante módulos ES nativos. El código de la aplicación está incrustado
   directamente en el HTML e incluye un componente separado en un archivo JS para ilustrar la división y montaje de módulos.

   EN: This project showcases a simple habits tracker built with Vue.js, using the Options API and HTML syntax.

   For simplicity, Vue is loaded from a CDN via native ES modules. The app code is embedded directly in the HTML and includes
   a separate component in a JS file to illustrate module splitting and mounting. -->
<html lang="es">
  <head>
    <title>Proyecto 16: Monitor de Hábitos</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Proyecto que muestra cómo crear una aplicación de seguimiento de hábitos con Vue.js utilizando la Options API, módulos ES y división de componentes. Dirigido a entusiastas del desarrollo web."
    />
    <!-- Project showcasing how to build a habits tracker app with Vue.js using Options API, ES modules, and component splitting. Intended for web development enthusiasts. -->
    <link rel="stylesheet" href="../CSS/sigue-habitos-style.css" />
  </head>

  <body>
    <div id="app" class="container" aria-live="polite">
      <h1>Monitor de Hábitos</h1>

      <form v-on:submit.prevent="addHabit">
        <div class="form-group">
          <label>¿Qué hábito quieres monitorear?</label>
          <input
            type="text"
            v-model="form.name"
            placeholder="e.g., Leer, Caminar, No fumar, etc."
            required
          />
        </div>

        <div class="form-group">
          <label>¿Cuando quieres empezar?</label>
          <input type="date" v-model="form.startDate" required />
        </div>

        <div class="form-group">
          <label>
            ¿Quieres contar desde el día uno o hacia atrás hasta una fecha
            objetivo?
          </label>
          <select v-model="form.mode">
            <option value="indefinite">Empezando el día uno</option>
            <option value="timed">Hasta una fecha objetivo</option>
          </select>
        </div>

        <div v-if="form.mode === 'timed'" class="form-group">
          <label>¿Cuál es la fecha objetivo?</label>
          <input type="date" v-model="form.targetDate" required />
        </div>

        <div class="form-actions">
          <button type="submit">Agregar</button>
          <button type="button" v-on:click="resetForm">Reiniciar</button>
        </div>
      </form>
      
      <div class="muted">Hábitos en progreso: {{ habits.length }}</div>

      <div v-if="habits.length === 0" class="muted no-habits">
        Agrega un hábito para empezar.
      </div>

      <div v-for="habit in sortedHabits" :key="habit.id" class="habit">
        <div class="meta">
          <div>
            <strong>{{ habit.name }}</strong>
            <span class="small">
              ({{ habit.mode === "indefinite" ? "Indefinido" : "Temporal" }})
            </span>
          </div>
          <div class="small" v-if="habit.mode === 'indefinite'">
            <span>Inicio: {{ dateStrFromDayMs(habit.start) }}</span>
            <span> ({{ daysFromStart(habit.start) }})</span>
          </div>
          <div class="small" v-if="habit.mode === 'timed'">
            <span>Objetivo: {{ dateStrFromDayMs(habit.target) }}</span>
            <span> ({{ daysLeft(habit.target) }})</span>
          </div>
        </div>
      </div>

      <div v-if="habits.length > 0">
        <button type="button" v-on:click="clearAll">BORRAR TODO</button>
      </div>
    </div>

    <script type="module">
      import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

      createApp({
        data() {
          return {
            habits: [],
            form: {
              name: "",
              startDate: new Date().toISOString().slice(0, 10),
              mode: "indefinite",
              targetDate: null
            }
          };
        },
        computed: {
          sortedHabits() {
            return [...this.habits].sort(
              (a, b) => (b.start || 0) - (a.start || 0)
            );
          }
        },
        watch: {
          // When startDate changes, if mode is timed set targetDate to next day
          "form.startDate"(newStart) {
            if (this.form.mode !== "timed") return;
            this.form.targetDate = this.nextDayStr(newStart);
          },

          // When mode switches to timed, set targetDate to startDate + 1 day
          "form.mode"(newMode) {
            if (newMode === "timed") {
              this.form.targetDate = this.nextDayStr(this.form.startDate);
            }
          }
        },
        methods: {
          // Unique ID
          uid() {
            return (
              Date.now().toString(36) + Math.random().toString(36).slice(2, 6)
            );
          },

          // parse YYYY-MM-DD to UTC ms at 00:00
          dayMsFromDateStr(dateStr) {
            const [y, m, d] = dateStr.split("-").map(Number);
            return Date.UTC(y, m - 1, d);
          },

          // format UTC ms to YYYY-MM-DD
          dateStrFromDayMs(dayMs) {
            const d = new Date(dayMs);
            const yy = d.getUTCFullYear();
            const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(d.getUTCDate()).padStart(2, "0");
            return `${yy}-${mm}-${dd}`;
          },

          // compute next day in UTC to avoid timezone shifts
          nextDayStr(dateStr) {
            const dayMs = this.dayMsFromDateStr(dateStr);
            const nextDayMs = dayMs + 24 * 60 * 60 * 1000;
            return this.dateStrFromDayMs(nextDayMs);
          },

          // compute days from start to today's date
          daysFromStart(startMs) {
            const differenceMs = Date.now() - startMs;
            const days =
              differenceMs <= 0
                ? 0
                : Math.ceil(differenceMs / 24 / 60 / 60 / 1000);
            return `${days} ${days > 1 ? "días" : "dia"}`;
          },

          // compute days from today to target date
          daysLeft(targetMs) {
            const targetDays = Math.ceil(
              (targetMs - Date.now()) / 24 / 60 / 60 / 1000
            );
            return targetDays > 1
              ? `en ${targetDays} días`
              : targetDays === 1
                ? "¡mañana!"
                : targetDays === 0
                  ? "¡hoy!"
                  : `Completado hace ${-targetDays} días`;
          },

          // Add habit with target date validation and logging
          addHabit() {
            const startMs = new Date(this.form.startDate).getTime();
            if (isNaN(startMs)) return alert("Fecha de inicio inválida");

            let targetMs = null;
            if (this.form.mode === "timed") {
              targetMs = new Date(this.form.targetDate).getTime();
              if (isNaN(targetMs)) return alert("Fecha objetivo inválida");
              if (targetMs <= startMs) {
                return alert(
                  "La fecha objetivo debe ser posterior a la fecha de inicio."
                );
              }
            }

            this.habits.push({
              id: this.uid(),
              name: (this.form.name || "Untitled").trim(),
              start: startMs,
              mode: this.form.mode,
              target: targetMs,
              active: true,
              logs: [],
              showLogs: false
            });
            console.table(
              this.habits.map((h) => ({
                id: h.id,
                name: h.name,
                start: new Date(h.start).toISOString().slice(0, 10),
                mode: h.mode,
                target: h.target
                  ? new Date(h.target).toISOString().slice(0, 10)
                  : null,
                active: h.active
              }))
            );

            this.resetForm();
          },

          resetForm() {
            this.form.name = "";
            this.form.startDate = new Date().toISOString().slice(0, 10);
            this.form.mode = "indefinite";
            this.form.targetDate = null;
          },

          clearAll() {
            if (confirm("¿Deseas eliminar todos los hábitos registrados?")) {
              this.habits.length = 0;
            }
          }
        }
      }).mount("#app");
    </script>
  </body>
</html>
